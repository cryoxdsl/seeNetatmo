<?php
declare(strict_types=1);

function supported_locales(): array
{
    return ['fr_FR', 'en_EN'];
}

function normalize_locale(?string $locale): string
{
    $locale = (string) $locale;
    return in_array($locale, supported_locales(), true) ? $locale : 'fr_FR';
}

function locale_switch_url(string $locale): string
{
    $uri = (string) ($_SERVER['REQUEST_URI'] ?? '/');
    $parts = parse_url($uri);
    $path = (string) ($parts['path'] ?? '/');
    $query = [];
    if (!empty($parts['query'])) {
        parse_str($parts['query'], $query);
    }
    $query['lang'] = $locale;
    return $path . '?' . http_build_query($query);
}

function i18n_bootstrap(): void
{
    $requested = isset($_GET['lang']) ? normalize_locale((string) $_GET['lang']) : null;
    if ($requested !== null) {
        $_SESSION['lang'] = $requested;
    }

    if (empty($_SESSION['lang'])) {
        $default = normalize_locale((string) cfg('default_locale', 'fr_FR'));
        $_SESSION['lang'] = $default;
    }
}

function locale_current(): string
{
    return normalize_locale((string) ($_SESSION['lang'] ?? cfg('default_locale', 'fr_FR')));
}

function t(string $key): string
{
    static $dict = [
        'fr_FR' => [
            'nav.live' => 'Live',
            'nav.charts' => 'Graphiques',
            'nav.history' => 'Historique',
            'footer.license' => 'Licence: CC BY 4.0',
            'footer.contact' => 'Contact',
            'lang.fr' => 'FR',
            'lang.en' => 'EN',
            'units.si' => 'SI',
            'units.imperial' => 'IMP',
            'status.connected' => 'Connecté',
            'status.disconnected' => 'Déconnecté',
            'dashboard.title' => 'Tableau de bord',
            'dashboard.last_update' => 'Dernière mise à jour',
            'dashboard.auto_refresh' => 'Rafraîchissement auto',
            'dashboard.disable' => 'Désactiver',
            'dashboard.enable' => 'Activer',
            'weather.unavailable' => 'Météo indisponible',
            'weather.trend.unavailable' => 'Tendance indisponible',
            'rain.total' => 'Pluviométrie cumulée',
            'rain.day_base' => 'Jour',
            'rain.month_base' => 'Mois',
            'rain.year_base' => 'Année',
            'rain.day' => 'Jour (mm)',
            'rain.month' => 'Mois (mm)',
            'rain.year' => 'Année (mm)',
            'btn.apply' => 'Appliquer',
            'btn.export_csv' => 'Exporter CSV',
            'history.title' => 'Historique',
            'charts.title' => 'Graphiques',
            'period.24h' => '24h',
            'period.7d' => '7 jours',
            'period.30d' => '30 jours',
            'period.month' => 'Mois en cours',
            'period.year' => 'Année en cours',
            'period.365d' => '365 jours glissants',
            'pagination.prev' => 'Précédent',
            'pagination.next' => 'Suivant',
            'pagination.page' => 'Page',
            'common.na' => 'N/A',
            'admin.title' => 'Admin',
            'admin.dashboard' => 'Tableau de bord',
            'admin.site' => 'Site',
            'admin.netatmo' => 'Netatmo',
            'admin.health' => 'Santé',
            'admin.logs' => 'Logs',
            'admin.upgrade' => 'Mise à jour',
            'admin.logout' => 'Déconnexion',
            'logs.title' => 'Journaux applicatifs',
            'logs.filter' => 'Filtrer',
            'logs.reset' => 'Réinitialiser',
            'logs.level' => 'Niveau',
            'logs.channel' => 'Canal',
            'logs.search' => 'Recherche',
            'logs.search_placeholder' => 'message/contexte',
            'logs.window' => 'Période',
            'logs.rows' => 'Lignes',
            'logs.all' => 'Tous',
            'logs.found' => 'log(s) trouvé(s)',
            'logs.no_results' => 'Aucun log trouvé.',
            'site.title' => 'Paramètres du site',
            'site.name' => 'Nom du site',
            'site.browser_title' => 'Titre navigateur',
            'site.favicon_url' => 'URL/chemin du favicon',
            'site.favicon_upload' => 'Uploader un favicon (ICO/PNG/JPG/WEBP, max 1 MB)',
            'site.favicon_current' => 'Favicon actuel',
            'site.contact' => 'Email de contact',
            'site.table' => 'Table des données',
            'site.default_locale' => 'Locale par défaut',
            'site.save' => 'Enregistrer',
            'site.saved' => 'Enregistré',
            'site.invalid' => 'Valeurs invalides',
            'metric.temperature' => 'Température (°C)',
            'metric.temperature_name' => 'Température',
            'metric.tmax_name' => 'Tmax',
            'metric.tmin_name' => 'Tmin',
            'metric.humidity' => 'Humidité (%)',
            'metric.humidity_name' => 'Humidité',
            'metric.pressure' => 'Pression (hPa)',
            'metric.pressure_name' => 'Pression',
            'metric.rain_1h' => 'Pluie 1h (mm)',
            'metric.rain_1h_name' => 'Pluie 1h',
            'metric.rain_day' => 'Pluie jour (mm)',
            'metric.rain_day_name' => 'Pluie jour',
            'metric.wind_avg' => 'Vent moyen (km/h)',
            'metric.wind_avg_name' => 'Vent moyen',
            'metric.wind_gust' => 'Rafales (km/h)',
            'metric.wind_gust_name' => 'Rafales',
            'metric.wind_dir' => 'Direction vent (°)',
            'metric.wind_dir_name' => 'Direction vent',
            'metric.dew_point' => 'Point de rosée (°C)',
            'metric.dew_point_name' => 'Point de rosée',
            'metric.apparent' => 'Température ressentie (°C)',
            'metric.apparent_name' => 'Température ressentie',
            'logs.message' => 'Message',
            'logs.context' => 'Contexte',
            'logs.date' => 'Date',
            'table.datetime' => 'Date/Heure',
            'table.temperature' => 'Température',
            'table.tmax' => 'Tmax',
            'table.tmin' => 'Tmin',
            'table.humidity' => 'Humidité',
            'table.dewpoint' => 'Point rosée',
            'table.wind_avg' => 'Vent moy.',
            'table.wind_gust' => 'Rafales',
            'table.wind_dir' => 'Dir vent',
            'table.rain_1h' => 'Pluie 1h',
            'table.rain_day' => 'Pluie jour',
            'table.pressure' => 'Pression',
            'table.s' => 'S',
            'table.apparent' => 'Ressenti',
            'upgrade.applied' => 'Migration appliquée',
            'upgrade.not_installed' => 'Application non installée',
            'login.title' => 'Connexion admin',
            'login.username' => 'Nom d\'utilisateur',
            'login.password' => 'Mot de passe',
            'login.continue' => 'Continuer',
            'login.failed' => 'Échec de connexion',
            'twofa.title' => 'Authentification à deux facteurs',
            'twofa.code' => 'Code TOTP ou de secours',
            'twofa.validate' => 'Valider',
            'twofa.invalid' => 'Code invalide',
            'twofa.backup_used' => 'Code de secours utilisé. Pensez à en regénérer.',
            'admin.last_datetime' => 'Dernier DateTime',
            'admin.temperature' => 'Température',
            'admin.pressure' => 'Pression',
            'netatmo.oauth' => 'OAuth Netatmo',
            'netatmo.client_id' => 'Client ID',
            'netatmo.client_secret' => 'Client Secret',
            'netatmo.save_credentials' => 'Enregistrer les identifiants',
            'netatmo.redirect_uri' => 'URI de redirection',
            'netatmo.token' => 'Token',
            'netatmo.configured' => 'Configuré',
            'netatmo.missing' => 'Manquant',
            'netatmo.expired' => 'expiré',
            'netatmo.connect' => 'Connecter / reconnecter Netatmo',
            'netatmo.credentials_saved' => 'Identifiants enregistrés',
            'netatmo.credentials_required' => 'client_id et client_secret requis',
            'netatmo.oauth_success' => 'Connexion OAuth réussie',
            'health.title' => 'Santé',
            'health.db_status' => 'Statut DB',
            'health.last_fetch' => 'Dernier cron fetch',
            'health.last_daily' => 'Dernier cron daily',
            'health.token_status' => 'Statut token',
            'health.error_24h' => 'Compteur erreurs 24h',
            'status.ok' => 'OK',
            'status.error' => 'ERREUR',
            'upgrade.title' => 'Mise à jour',
            'upgrade.target_version' => 'Version cible',
            'upgrade.run' => 'Lancer la mise à jour',
            'upgrade.back_admin' => 'Retour admin',
            'weather.label.offline' => 'Station deconnectee',
            'weather.detail.offline' => 'Aucune mesure recente du module exterieur',
            'weather.label.snow' => 'Neige',
            'weather.detail.snow' => 'Precipitations froides detectees',
            'weather.label.rain' => 'Pluie',
            'weather.detail.rain' => 'Precipitations en cours',
            'weather.label.wind' => 'Vent fort',
            'weather.detail.wind' => 'Rafales soutenues',
            'weather.label.very_cloudy' => 'Tres nuageux',
            'weather.detail.very_cloudy' => 'Humidite elevee',
            'weather.label.cloudy' => 'Nuageux',
            'weather.detail.cloudy' => 'Ciel charge',
            'weather.label.sunny' => 'Grand soleil',
            'weather.detail.sunny' => 'Air plutot sec',
            'weather.label.voile' => 'Voile',
            'weather.detail.voile' => 'Ciel partiellement couvert',
            'weather.trend.up' => 'Tendance temperature: hausse',
            'weather.trend.down' => 'Tendance temperature: baisse',
            'weather.trend.stable' => 'Tendance temperature: stable',
            'weather.trend.unknown' => 'Tendance temperature: inconnue',
            'install.disabled' => 'Installateur désactivé (installed.lock existe).',
            'install.title' => 'Installateur',
            'install.step' => 'Étape',
            'install.complete' => 'Installation terminée',
            'install.run_checks' => 'Lancer les vérifications',
            'install.check_desc' => 'Vérifier PHP, extensions et droit d\'écriture sur /config.',
            'install.connect' => 'Connecter',
            'install.verify_table' => 'Vérifier table + PK',
            'install.create_tables' => 'Créer les tables',
            'install.create_tables_desc' => 'Créer les tables applicatives requises si elles sont absentes.',
            'install.create_admin' => 'Créer admin + seed 2FA',
            'install.save_netatmo' => 'Enregistrer identifiants Netatmo',
            'install.generate_keys' => 'Générer les clés',
            'install.finalize' => 'Finaliser l\'installation',
            'install.finalize_desc' => 'Finaliser: créer user/settings/secrets/config + lock.',
        ],
        'en_EN' => [
            'nav.live' => 'Live',
            'nav.charts' => 'Charts',
            'nav.history' => 'History',
            'footer.license' => 'License: CC BY 4.0',
            'footer.contact' => 'Contact',
            'lang.fr' => 'FR',
            'lang.en' => 'EN',
            'units.si' => 'SI',
            'units.imperial' => 'IMP',
            'status.connected' => 'Connected',
            'status.disconnected' => 'Disconnected',
            'dashboard.title' => 'Live dashboard',
            'dashboard.last_update' => 'Last update',
            'dashboard.auto_refresh' => 'Auto refresh',
            'dashboard.disable' => 'Disable',
            'dashboard.enable' => 'Enable',
            'weather.unavailable' => 'Weather unavailable',
            'weather.trend.unavailable' => 'Trend unavailable',
            'rain.total' => 'Cumulative rainfall',
            'rain.day_base' => 'Day',
            'rain.month_base' => 'Month',
            'rain.year_base' => 'Year',
            'rain.day' => 'Day (mm)',
            'rain.month' => 'Month (mm)',
            'rain.year' => 'Year (mm)',
            'btn.apply' => 'Apply',
            'btn.export_csv' => 'Export CSV',
            'history.title' => 'History',
            'charts.title' => 'Charts',
            'period.24h' => '24h',
            'period.7d' => '7 days',
            'period.30d' => '30 days',
            'period.month' => 'Current month',
            'period.year' => 'Current year',
            'period.365d' => 'Rolling 365 days',
            'pagination.prev' => 'Prev',
            'pagination.next' => 'Next',
            'pagination.page' => 'Page',
            'common.na' => 'N/A',
            'admin.title' => 'Admin',
            'admin.dashboard' => 'Dashboard',
            'admin.site' => 'Site',
            'admin.netatmo' => 'Netatmo',
            'admin.health' => 'Health',
            'admin.logs' => 'Logs',
            'admin.upgrade' => 'Upgrade',
            'admin.logout' => 'Logout',
            'logs.title' => 'Application logs',
            'logs.filter' => 'Filter',
            'logs.reset' => 'Reset',
            'logs.level' => 'Level',
            'logs.channel' => 'Channel',
            'logs.search' => 'Search',
            'logs.search_placeholder' => 'message/context',
            'logs.window' => 'Window',
            'logs.rows' => 'Rows',
            'logs.all' => 'All',
            'logs.found' => 'log(s) found',
            'logs.no_results' => 'No logs found.',
            'site.title' => 'Site settings',
            'site.name' => 'Site name',
            'site.browser_title' => 'Browser title',
            'site.favicon_url' => 'Favicon URL/path',
            'site.favicon_upload' => 'Upload favicon (ICO/PNG/JPG/WEBP, max 1 MB)',
            'site.favicon_current' => 'Current favicon',
            'site.contact' => 'Contact email',
            'site.table' => 'Data table',
            'site.default_locale' => 'Default locale',
            'site.save' => 'Save',
            'site.saved' => 'Saved',
            'site.invalid' => 'Invalid values',
            'metric.temperature' => 'Temperature (°C)',
            'metric.temperature_name' => 'Temperature',
            'metric.tmax_name' => 'Tmax',
            'metric.tmin_name' => 'Tmin',
            'metric.humidity' => 'Humidity (%)',
            'metric.humidity_name' => 'Humidity',
            'metric.pressure' => 'Pressure (hPa)',
            'metric.pressure_name' => 'Pressure',
            'metric.rain_1h' => 'Rain 1h (mm)',
            'metric.rain_1h_name' => 'Rain 1h',
            'metric.rain_day' => 'Rain day (mm)',
            'metric.rain_day_name' => 'Rain day',
            'metric.wind_avg' => 'Wind avg (km/h)',
            'metric.wind_avg_name' => 'Wind avg',
            'metric.wind_gust' => 'Wind gust (km/h)',
            'metric.wind_gust_name' => 'Wind gust',
            'metric.wind_dir' => 'Wind dir (°)',
            'metric.wind_dir_name' => 'Wind dir',
            'metric.dew_point' => 'Dew point (°C)',
            'metric.dew_point_name' => 'Dew point',
            'metric.apparent' => 'Apparent (°C)',
            'metric.apparent_name' => 'Apparent',
            'logs.message' => 'Message',
            'logs.context' => 'Context',
            'logs.date' => 'Date',
            'table.datetime' => 'DateTime',
            'table.temperature' => 'Temperature',
            'table.tmax' => 'Tmax',
            'table.tmin' => 'Tmin',
            'table.humidity' => 'Humidity',
            'table.dewpoint' => 'Dew point',
            'table.wind_avg' => 'Wind avg',
            'table.wind_gust' => 'Wind gust',
            'table.wind_dir' => 'Wind dir',
            'table.rain_1h' => 'Rain 1h',
            'table.rain_day' => 'Rain day',
            'table.pressure' => 'Pressure',
            'table.s' => 'S',
            'table.apparent' => 'Apparent',
            'upgrade.applied' => 'Migration applied',
            'upgrade.not_installed' => 'Application not installed',
            'login.title' => 'Admin login',
            'login.username' => 'Username',
            'login.password' => 'Password',
            'login.continue' => 'Continue',
            'login.failed' => 'Login failed',
            'twofa.title' => 'Two-factor authentication',
            'twofa.code' => 'TOTP or backup code',
            'twofa.validate' => 'Validate',
            'twofa.invalid' => 'Invalid code',
            'twofa.backup_used' => 'Backup code used. Generate a new one if needed.',
            'admin.last_datetime' => 'Last DateTime',
            'admin.temperature' => 'Temperature',
            'admin.pressure' => 'Pressure',
            'netatmo.oauth' => 'Netatmo OAuth',
            'netatmo.client_id' => 'Client ID',
            'netatmo.client_secret' => 'Client Secret',
            'netatmo.save_credentials' => 'Save credentials',
            'netatmo.redirect_uri' => 'Redirect URI',
            'netatmo.token' => 'Token',
            'netatmo.configured' => 'Configured',
            'netatmo.missing' => 'Missing',
            'netatmo.expired' => 'expired',
            'netatmo.connect' => 'Connect / reconnect Netatmo',
            'netatmo.credentials_saved' => 'Credentials saved',
            'netatmo.credentials_required' => 'client_id and client_secret required',
            'netatmo.oauth_success' => 'OAuth connection successful',
            'health.title' => 'Health',
            'health.db_status' => 'DB status',
            'health.last_fetch' => 'Last cron fetch',
            'health.last_daily' => 'Last cron daily',
            'health.token_status' => 'Token status',
            'health.error_24h' => 'Error counter 24h',
            'status.ok' => 'OK',
            'status.error' => 'ERROR',
            'upgrade.title' => 'Upgrade',
            'upgrade.target_version' => 'Target version',
            'upgrade.run' => 'Run upgrade',
            'upgrade.back_admin' => 'Back admin',
            'weather.label.offline' => 'Station offline',
            'weather.detail.offline' => 'No recent data from outdoor module',
            'weather.label.snow' => 'Snow',
            'weather.detail.snow' => 'Cold precipitation detected',
            'weather.label.rain' => 'Rain',
            'weather.detail.rain' => 'Precipitation in progress',
            'weather.label.wind' => 'Windy',
            'weather.detail.wind' => 'Strong gusts detected',
            'weather.label.very_cloudy' => 'Very cloudy',
            'weather.detail.very_cloudy' => 'High humidity',
            'weather.label.cloudy' => 'Cloudy',
            'weather.detail.cloudy' => 'Loaded sky',
            'weather.label.sunny' => 'Sunny',
            'weather.detail.sunny' => 'Dryer air',
            'weather.label.voile' => 'Partly cloudy',
            'weather.detail.voile' => 'Partly covered sky',
            'weather.trend.up' => 'Temperature trend: rising',
            'weather.trend.down' => 'Temperature trend: falling',
            'weather.trend.stable' => 'Temperature trend: stable',
            'weather.trend.unknown' => 'Temperature trend: unknown',
            'install.disabled' => 'Installer disabled (installed.lock exists).',
            'install.title' => 'Installer',
            'install.step' => 'Step',
            'install.complete' => 'Installation complete',
            'install.run_checks' => 'Run checks',
            'install.check_desc' => 'Check PHP, extensions and /config write access.',
            'install.connect' => 'Connect',
            'install.verify_table' => 'Verify table + PK',
            'install.create_tables' => 'Create tables',
            'install.create_tables_desc' => 'Create required app tables if missing.',
            'install.create_admin' => 'Create admin + 2FA seed',
            'install.save_netatmo' => 'Save Netatmo credentials',
            'install.generate_keys' => 'Generate keys',
            'install.finalize' => 'Finalize installation',
            'install.finalize_desc' => 'Finalize: create user/settings/secrets/config files + lock.',
        ],
    ];

    $locale = locale_current();
    return $dict[$locale][$key] ?? $dict['fr_FR'][$key] ?? $key;
}
