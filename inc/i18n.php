<?php
declare(strict_types=1);

function supported_locales(): array
{
    return ['fr_FR', 'en_EN'];
}

function normalize_locale(?string $locale): string
{
    $locale = (string) $locale;
    return in_array($locale, supported_locales(), true) ? $locale : 'fr_FR';
}

function locale_switch_url(string $locale): string
{
    $uri = (string) ($_SERVER['REQUEST_URI'] ?? '/');
    $parts = parse_url($uri);
    $path = (string) ($parts['path'] ?? '/');
    $query = [];
    if (!empty($parts['query'])) {
        parse_str($parts['query'], $query);
    }
    $query['lang'] = $locale;
    return $path . '?' . http_build_query($query);
}

function browser_preferred_locale(): string
{
    $accept = strtolower((string) ($_SERVER['HTTP_ACCEPT_LANGUAGE'] ?? ''));
    if ($accept === '') {
        return 'en_EN';
    }

    $parts = explode(',', $accept);
    foreach ($parts as $part) {
        $lang = trim(explode(';', $part)[0] ?? '');
        if ($lang === '') {
            continue;
        }
        if ($lang === 'fr' || str_starts_with($lang, 'fr-') || str_starts_with($lang, 'fr_')) {
            return 'fr_FR';
        }
        return 'en_EN';
    }

    return 'en_EN';
}

function i18n_bootstrap(): void
{
    $requested = isset($_GET['lang']) ? normalize_locale((string) $_GET['lang']) : null;
    if ($requested !== null) {
        $_SESSION['lang'] = $requested;
    }

    if (empty($_SESSION['lang'])) {
        $_SESSION['lang'] = browser_preferred_locale();
    }
}

function locale_current(): string
{
    return normalize_locale((string) ($_SESSION['lang'] ?? cfg('default_locale', 'fr_FR')));
}

function t(string $key): string
{
    static $dict = [
        'fr_FR' => [
            'nav.live' => 'Live',
            'nav.charts' => 'Graphiques',
            'nav.climate' => 'Climat',
            'nav.history' => 'Historique',
            'footer.license' => 'Licence: CC BY 4.0',
            'footer.contact' => 'Contact',
            'footer.terms' => 'Conditions d\'utilisation',
            'lang.fr' => 'FR',
            'lang.en' => 'EN',
            'lang.fr_full' => 'Français (France)',
            'lang.en_full' => 'English',
            'units.si' => 'SI',
            'units.imperial' => 'IMP',
            'units.si_full' => 'Système international',
            'units.imperial_full' => 'Unités impériales',
            'status.connected' => 'Connecté',
            'status.disconnected' => 'Déconnecté',
            'dashboard.title' => 'Tableau de bord',
            'dashboard.last_update' => 'Dernière mise à jour',
            'dashboard.auto_refresh' => 'Rafraîchissement auto',
            'dashboard.auto_refresh_reloading' => 'Rechargement...',
            'dashboard.refresh_cache' => 'Rafraîchir le cache',
            'dashboard.refresh_cache_busy' => 'Rafraîchissement...',
            'dashboard.theme' => 'Thème',
            'dashboard.theme_auto' => 'Auto',
            'dashboard.theme_light' => 'Clair',
            'dashboard.theme_dark' => 'Sombre',
            'dashboard.disable' => 'Désactiver',
            'dashboard.enable' => 'Activer',
            'dashboard.current_temp' => 'Actuelle',
            'dashboard.day_min' => 'Min jour',
            'dashboard.day_max' => 'Max jour',
            'seo.default_description' => 'Station météo locale avec observations en direct, graphiques, climatologie et historique.',
            'seo.dashboard_description' => 'Données météo en direct de la station : température, pluie, vent, pression et tendances.',
            'seo.charts_description' => 'Graphiques météo interactifs : température, humidité, pression, vent et pluviométrie.',
            'seo.history_description' => 'Historique détaillé des relevés météo de la station.',
            'seo.climate_description' => 'Synthèse climatologique mensuelle et annuelle de la station météo.',
            'seo.terms_description' => 'Conditions d\'utilisation du site météo et informations légales.',
            'weather.unavailable' => 'Météo indisponible',
            'weather.trend.unavailable' => 'Tendance indisponible',
            'rain.total' => 'Pluviométrie cumulée',
            'sea.title' => 'Température de la mer',
            'sea.subtitle' => 'Point marin le plus proche',
            'sea.distance' => 'Distance',
            'sea.updated' => 'Mesure',
            'forecast.title' => 'Prévision météo',
            'forecast.today' => 'Aujourd\'hui',
            'forecast.tomorrow' => 'Demain',
            'forecast.precip' => 'Pluie probable',
            'forecast.updated' => 'Prévision mise à jour',
            'forecast.unavailable' => 'Prévision indisponible',
            'forecast.coords_required' => 'Définissez la latitude/longitude de la station dans l\'admin.',
            'forecast.retry_later' => 'Réessai en cours, rechargez la page dans quelques instants.',
            'metar.title' => 'METAR',
            'metar.nearest' => 'Aéroport le plus proche',
            'metar.raw' => 'Message brut',
            'metar.observed' => 'Observation',
            'metar.weather' => 'Temps',
            'metar.clouds' => 'Nuages',
            'metar.decoded' => 'Décodage',
            'metar.unavailable' => 'METAR indisponible',
            'forecast.condition.clear' => 'Ensoleillé',
            'forecast.condition.partly_cloudy' => 'Éclaircies',
            'forecast.condition.overcast' => 'Couvert',
            'forecast.condition.fog' => 'Brouillard',
            'forecast.condition.drizzle' => 'Bruine',
            'forecast.condition.rain' => 'Pluie',
            'forecast.condition.snow' => 'Neige',
            'forecast.condition.showers' => 'Averses',
            'forecast.condition.snow_showers' => 'Averses de neige',
            'forecast.condition.thunderstorm' => 'Orage',
            'forecast.condition.unknown' => 'Temps variable',
            'station.card_title' => 'Station',
            'station.location' => 'Position',
            'station.altitude' => 'Altitude',
            'station.status' => 'Statut',
            'station.last_update' => 'Dernière mise à jour',
            'extremes.card_title' => 'Extrêmes & éphéméride',
            'extremes.day_min' => 'Min du jour',
            'extremes.day_max' => 'Max du jour',
            'extremes.historical_avg' => 'Moyenne historique',
            'extremes.day_min_time' => 'Heure min',
            'extremes.day_max_time' => 'Heure max',
            'extremes.sunrise' => 'Lever du soleil',
            'extremes.sunset' => 'Coucher du soleil',
            'extremes.day_length' => 'Durée du jour',
            'extremes.moment' => 'Moment de la journée',
            'extremes.phase.before_sunrise' => 'Avant le lever',
            'extremes.phase.daylight' => 'En journée',
            'extremes.phase.after_sunset' => 'Après le coucher',
            'extremes.event_ago' => 'Il y a %s heure(s)',
            'extremes.event_in' => 'Dans %s heure(s)',
            'extremes.day_length_more' => '%d min de plus qu\'hier',
            'extremes.day_length_less' => '%d min de moins qu\'hier',
            'extremes.day_length_same' => 'Même durée qu\'hier',
            'rain.day_base' => 'Jour',
            'rain.month_base' => 'Mois',
            'rain.year_base' => 'Année',
            'rain.rolling_year_base' => '365 jours',
            'rain.day' => 'Jour (mm)',
            'rain.month' => 'Mois (mm)',
            'rain.year' => 'Année (mm)',
            'rain.delta_day_vs_avg' => 'Δ vs moyenne même jour (autres années)',
            'rain.delta_month_vs_avg' => 'Δ vs moyenne même mois (autres années)',
            'rain.delta_year_vs_same_date_avg' => 'Δ vs moyenne à la même date (autres années)',
            'rain.delta_rolling_vs_avg' => 'Δ vs moyenne 365 jours (autres années)',
            'windrose.title' => 'Rosace des vents',
            'windrose.samples' => 'Mesures du jour',
            'windrose.no_data' => 'Pas assez de données vent pour la journée.',
            'windrose.period.1j' => '1j',
            'windrose.period.1s' => '1s',
            'windrose.period.1m' => '1m',
            'windrose.period.1a' => '1a',
            'windrose.dominant' => 'Secteur dominant',
            'windrose.top' => 'Secteurs dominants',
            'windrose.samples_for' => 'Mesures (%s)',
            'btn.apply' => 'Appliquer',
            'btn.export_csv' => 'Exporter CSV',
            'history.title' => 'Historique',
            'charts.title' => 'Graphiques',
            'charts.density' => 'Densité',
            'charts.density.auto' => 'Auto',
            'charts.density.compact' => 'Compact',
            'charts.density.dense' => 'Dense',
            'climate.title' => 'Climat',
            'climate.mode' => 'Vue',
            'climate.monthly' => 'Mensualisée',
            'climate.yearly' => 'Annualisée',
            'climate.year' => 'Année',
            'climate.period' => 'Période',
            'climate.temp_range' => 'Température min/max',
            'climate.pressure_range' => 'Pression min/max',
            'climate.rain_total' => 'Pluviométrie totale',
            'climate.rain_1h_max' => 'Pluie 1h max',
            'climate.wind_max' => 'Vent max',
            'climate.gust_max' => 'Rafale max',
            'climate.dew_range' => 'Point de rosée min/max',
            'climate.apparent_range' => 'Temp. ressentie min/max',
            'period.24h' => '24h',
            'period.7d' => '7 jours',
            'period.30d' => '30 jours',
            'period.month' => 'Mois en cours',
            'period.year' => 'Année en cours',
            'period.365d' => '365 jours glissants',
            'period.custom' => 'Période personnalisée',
            'charts.from' => 'Du',
            'charts.to' => 'Au',
            'pagination.prev' => 'Précédent',
            'pagination.next' => 'Suivant',
            'pagination.page' => 'Page',
            'common.na' => 'N/A',
            'common.yesterday' => 'Hier',
            'admin.title' => 'Admin',
            'admin.dashboard' => 'Tableau de bord',
            'admin.site' => 'Site',
            'admin.twofa' => '2FA',
            'admin.netatmo' => 'Netatmo',
            'admin.health' => 'Santé',
            'admin.stats' => 'Statistiques',
            'admin.logs' => 'Logs',
            'admin.backups' => 'Sauvegardes',
            'admin.upgrade' => 'Mise à jour',
            'admin.logout' => 'Déconnexion',
            'admin.logout_confirm' => 'Confirmer la déconnexion ?',
            'backup.title' => 'Sauvegardes SQL',
            'backup.subtitle' => 'Exports de sécurité à télécharger.',
            'backup.alldata_title' => 'Export table alldata',
            'backup.alldata_desc' => 'Télécharge un dump SQL de la table alldata.',
            'backup.db_title' => 'Export base complète',
            'backup.db_desc' => 'Télécharge un dump SQL de toutes les tables de la base.',
            'backup.download_alldata' => 'Télécharger alldata.sql',
            'backup.download_db' => 'Télécharger database.sql',
            'backup.table_missing' => 'La table alldata est introuvable dans cette base.',
            'backup.error' => 'Échec export SQL',
            'logs.title' => 'Journaux applicatifs',
            'logs.filter' => 'Filtrer',
            'logs.reset' => 'Réinitialiser',
            'logs.level' => 'Niveau',
            'logs.channel' => 'Canal',
            'logs.search' => 'Recherche',
            'logs.search_placeholder' => 'message/contexte',
            'logs.window' => 'Période',
            'logs.rows' => 'Lignes',
            'logs.all' => 'Tous',
            'logs.found' => 'log(s) trouvé(s)',
            'logs.no_results' => 'Aucun log trouvé.',
            'stats.title' => 'Statistiques de consultation',
            'stats.window' => 'Période',
            'stats.sessions' => 'Sessions',
            'stats.unique_ips' => 'IP uniques',
            'stats.pageviews' => 'Pages vues',
            'stats.avg_duration' => 'Durée moyenne',
            'stats.total_duration' => 'Temps total',
            'stats.top_pages' => 'Pages les plus vues',
            'stats.page' => 'Page',
            'stats.views' => 'Vues',
            'stats.time_spent' => 'Temps passé',
            'stats.top_geo' => 'Répartition géographique',
            'stats.country' => 'Pays',
            'stats.recent_sessions' => 'Sessions récentes',
            'stats.start' => 'Début',
            'stats.last_seen' => 'Dernier signal',
            'stats.geo' => 'Géolocalisation',
            'stats.pages' => 'Pages',
            'stats.entry' => 'Entrée',
            'stats.exit' => 'Sortie',
            'site.title' => 'Paramètres du site',
            'site.name' => 'Nom du site',
            'site.browser_title' => 'Titre navigateur',
            'site.favicon_url' => 'URL/chemin du favicon',
            'site.weather_icon_style' => 'Style icône météo (Live)',
            'site.weather_icon_style_realistic' => 'Réaliste',
            'site.weather_icon_style_minimal' => 'Minimal',
            'site.weather_icon_style_outline' => 'Contour',
            'site.weather_icon_style_glyph' => 'Pictogramme',
            'site.favicon_upload' => 'Uploader un favicon (ICO/PNG/JPG/WEBP, max 1 MB)',
            'site.favicon_current' => 'Favicon actuel',
            'site.contact' => 'Email de contact',
            'site.table' => 'Table des données',
            'site.default_locale' => 'Locale par défaut',
            'site.station_zipcode' => 'Code postal station (optionnel)',
            'site.station_lat' => 'Latitude station (optionnel)',
            'site.station_lon' => 'Longitude station (optionnel)',
            'site.station_altitude' => 'Altitude station (m, optionnel)',
            'site.forecast_sources' => 'Sources de prévision',
            'site.forecast_source_openmeteo' => 'Open-Meteo',
            'site.forecast_source_metno' => 'MET Norway (met.no)',
            'site.forecast_sources_help' => 'Plusieurs sources possibles. La première disponible est utilisée automatiquement.',
            'site.metar_default_icao' => 'Aéroport METAR par défaut (code ICAO)',
            'site.metar_default_icao_help' => 'Code ICAO sur 4 lettres (ex: LFML). Utilisé si la détection automatique échoue.',
            'site.station_lock_position' => 'Verrouiller la position manuelle (ne pas écraser via Netatmo)',
            'site.save' => 'Enregistrer',
            'site.saved' => 'Enregistré',
            'site.invalid' => 'Valeurs invalides',
            'site.terms_content' => 'Contenu des conditions d\'utilisation',
            'site.terms_content_help' => 'HTML autorisé (p, br, strong, em, ul/ol/li, a, h2-h4, blockquote). Les balises non sûres sont filtrées.',
            'terms.title' => 'Conditions d\'utilisation',
            'terms.empty' => 'Aucune condition d\'utilisation n\'a encore ete definie.',
            'metric.temperature' => 'Température (°C)',
            'metric.temperature_name' => 'Température',
            'metric.tmax_name' => 'Tmax',
            'metric.tmin_name' => 'Tmin',
            'metric.humidity' => 'Humidité (%)',
            'metric.humidity_name' => 'Humidité',
            'metric.pressure' => 'Pression (hPa)',
            'metric.pressure_name' => 'Pression',
            'metric.rain_1h' => 'Pluie 1h (mm)',
            'metric.rain_1h_name' => 'Pluie 1h',
            'metric.rain_day' => 'Pluie jour (mm)',
            'metric.rain_day_name' => 'Pluie jour',
            'metric.wind_avg' => 'Vent moyen (km/h)',
            'metric.wind_avg_name' => 'Vent moyen',
            'metric.wind_gust' => 'Rafales (km/h)',
            'metric.wind_gust_name' => 'Rafales',
            'metric.wind_dir' => 'Direction vent (°)',
            'metric.wind_dir_name' => 'Direction vent',
            'metric.dew_point' => 'Point de rosée (°C)',
            'metric.dew_point_name' => 'Point de rosée',
            'metric.apparent' => 'Température ressentie (°C)',
            'metric.apparent_name' => 'Température ressentie',
            'metrics.by_type' => 'Métriques par typologie',
            'metric.group.thermal' => 'Thermique et humidité',
            'metric.group.wind' => 'Vent',
            'metric.group.rain' => 'Pluie',
            'metric.group.pressure' => 'Pression',
            'metric.rain_episode_start' => 'Début épisode',
            'metric.rain_episode_end' => 'Fin épisode',
            'metric.rain_episode_ongoing' => 'En cours',
            'metric.wind_dir_compass' => 'Direction du vent (boussole)',
            'metric.wind_dir_label' => 'Orientation',
            'metric.wind_from_sector' => 'De secteur',
            'metric.day_min_max' => 'Min/Max jour',
            'metric.pressure_trend' => 'Tendance',
            'logs.message' => 'Message',
            'logs.context' => 'Contexte',
            'logs.date' => 'Date',
            'table.datetime' => 'Date/Heure',
            'table.temperature' => 'Température',
            'table.tmax' => 'Tmax',
            'table.tmin' => 'Tmin',
            'table.humidity' => 'Humidité',
            'table.dewpoint' => 'Point rosée',
            'table.wind_avg' => 'Vent moy.',
            'table.wind_gust' => 'Rafales',
            'table.wind_dir' => 'Dir vent',
            'table.rain_1h' => 'Pluie 1h',
            'table.rain_day' => 'Pluie jour',
            'table.pressure' => 'Pression',
            'table.s' => 'S',
            'table.apparent' => 'Ressenti',
            'upgrade.applied' => 'Migration appliquée',
            'upgrade.not_installed' => 'Application non installée',
            'login.title' => 'Connexion admin',
            'login.username' => 'Nom d\'utilisateur',
            'login.password' => 'Mot de passe',
            'login.continue' => 'Continuer',
            'login.failed' => 'Échec de connexion',
            'login.logged_out' => 'Vous êtes déconnecté.',
            'auth.invalid_credentials' => 'Identifiants invalides',
            'auth.too_many_attempts' => 'Trop de tentatives échouées. Réessayez dans 10 minutes.',
            'auth.no_pending_login' => 'Aucune connexion en attente',
            'auth.invalid_2fa' => 'Code TOTP/code de secours invalide',
            'twofa.title' => 'Authentification à deux facteurs',
            'twofa.manage_title' => 'Gestion 2FA',
            'twofa.status' => 'Statut',
            'twofa.status_enabled' => 'Activée',
            'twofa.status_disabled' => 'Désactivée',
            'twofa.enable' => 'Activer la 2FA',
            'twofa.disable' => 'Désactiver la 2FA',
            'twofa.regenerate' => 'Regénérer QR + codes de secours',
            'twofa.enabled' => '2FA activée',
            'twofa.disabled' => '2FA désactivée',
            'twofa.scan_qr' => 'Configurez votre application TOTP avec le secret ou l\'URI ci-dessous',
            'twofa.secret' => 'Secret',
            'twofa.backup_codes' => 'Codes de secours (à conserver)',
            'twofa.confirm_disable' => 'Désactiver la 2FA pour ce compte ?',
            'twofa.confirm_password' => 'Confirmer avec le mot de passe admin',
            'twofa.disable_bad_password' => 'Mot de passe invalide',
            'twofa.warning_disabled' => 'La 2FA est désactivée pour ce compte admin. Activez-la pour renforcer la sécurité.',
            'twofa.code' => 'Code TOTP ou de secours',
            'twofa.remember_device' => 'Se souvenir de cet appareil pendant 30 jours',
            'twofa.remember_device_help' => 'À utiliser uniquement sur un appareil personnel de confiance.',
            'twofa.validate' => 'Valider',
            'twofa.invalid' => 'Code invalide',
            'twofa.backup_used' => 'Code de secours utilisé. Pensez à en regénérer.',
            'admin.last_datetime' => 'Dernier DateTime',
            'admin.temperature' => 'Température',
            'admin.pressure' => 'Pression',
            'netatmo.oauth' => 'OAuth Netatmo',
            'netatmo.client_id' => 'Client ID',
            'netatmo.client_secret' => 'Client Secret',
            'netatmo.save_credentials' => 'Enregistrer les identifiants',
            'netatmo.redirect_uri' => 'URI de redirection',
            'netatmo.token' => 'Token',
            'netatmo.configured' => 'Configuré',
            'netatmo.missing' => 'Manquant',
            'netatmo.expired' => 'expiré',
            'netatmo.connect' => 'Connecter / reconnecter Netatmo',
            'netatmo.credentials_saved' => 'Identifiants enregistrés',
            'netatmo.credentials_required' => 'client_id et client_secret requis',
            'netatmo.oauth_success' => 'Connexion OAuth réussie',
            'health.title' => 'Santé',
            'health.db_status' => 'Statut DB',
            'health.last_fetch' => 'Dernier cron fetch',
            'health.last_daily' => 'Dernier cron daily',
            'health.last_external' => 'Dernier cron external',
            'health.token_status' => 'Statut token',
            'health.error_24h' => 'Compteur erreurs 24h',
            'health.position' => 'Position active utilisée',
            'health.position_source' => 'Source',
            'health.position_lock' => 'Verrouillage',
            'health.position_manual' => 'Manuelle',
            'health.position_auto' => 'Netatmo auto',
            'health.position_on' => 'Activé',
            'health.position_off' => 'Désactivé',
            'health.release_tag' => 'Release',
            'health.release_source' => 'Source release',
            'status.ok' => 'OK',
            'status.error' => 'ERREUR',
            'upgrade.title' => 'Mise à jour',
            'upgrade.target_version' => 'Version cible',
            'upgrade.run' => 'Lancer la mise à jour',
            'upgrade.back_admin' => 'Retour admin',
            'weather.label.offline' => 'Station déconnectée',
            'weather.detail.offline' => 'Aucune mesure récente du module extérieur',
            'weather.label.snow' => 'Neige',
            'weather.detail.snow' => 'Précipitations froides détectées',
            'weather.label.rain' => 'Pluie',
            'weather.detail.rain' => 'Précipitations en cours',
            'weather.label.wind' => 'Vent fort',
            'weather.detail.wind' => 'Rafales soutenues',
            'weather.label.very_cloudy' => 'Très nuageux',
            'weather.detail.very_cloudy' => 'Humidité élevée',
            'weather.label.cloudy' => 'Nuageux',
            'weather.detail.cloudy' => 'Ciel chargé',
            'weather.label.sunny' => 'Grand soleil',
            'weather.detail.sunny' => 'Air plutôt sec',
            'weather.label.voile' => 'Voile',
            'weather.detail.voile' => 'Ciel partiellement couvert',
            'weather.trend.up' => 'Tendance température : hausse',
            'weather.trend.down' => 'Tendance température : baisse',
            'weather.trend.stable' => 'Tendance température : stable',
            'weather.trend.unknown' => 'Tendance température : inconnue',
            'install.disabled' => 'Installateur désactivé (installed.lock existe).',
            'install.title' => 'Installateur',
            'install.step' => 'Étape',
            'install.complete' => 'Installation terminée',
            'install.run_checks' => 'Lancer les vérifications',
            'install.check_desc' => 'Vérifier PHP, extensions et droit d\'écriture sur /config.',
            'install.connect' => 'Connecter',
            'install.verify_table' => 'Vérifier table + PK',
            'install.create_tables' => 'Créer les tables',
            'install.create_tables_desc' => 'Créer les tables applicatives requises si elles sont absentes.',
            'install.create_admin' => 'Créer admin + seed 2FA',
            'install.save_netatmo' => 'Enregistrer identifiants Netatmo',
            'install.generate_keys' => 'Générer les clés',
            'install.finalize' => 'Finaliser l\'installation',
            'install.finalize_desc' => 'Finaliser: créer user/settings/secrets/config + lock.',
        ],
        'en_EN' => [
            'nav.live' => 'Live',
            'nav.charts' => 'Charts',
            'nav.climate' => 'Climate',
            'nav.history' => 'History',
            'footer.license' => 'License: CC BY 4.0',
            'footer.contact' => 'Contact',
            'footer.terms' => 'Terms of use',
            'lang.fr' => 'FR',
            'lang.en' => 'EN',
            'lang.fr_full' => 'French (France)',
            'lang.en_full' => 'English',
            'units.si' => 'SI',
            'units.imperial' => 'IMP',
            'units.si_full' => 'International System (SI)',
            'units.imperial_full' => 'Imperial units',
            'status.connected' => 'Connected',
            'status.disconnected' => 'Disconnected',
            'dashboard.title' => 'Live dashboard',
            'dashboard.last_update' => 'Last update',
            'dashboard.auto_refresh' => 'Auto refresh',
            'dashboard.auto_refresh_reloading' => 'Reloading...',
            'dashboard.refresh_cache' => 'Refresh cache',
            'dashboard.refresh_cache_busy' => 'Refreshing...',
            'dashboard.theme' => 'Theme',
            'dashboard.theme_auto' => 'Auto',
            'dashboard.theme_light' => 'Light',
            'dashboard.theme_dark' => 'Dark',
            'dashboard.disable' => 'Disable',
            'dashboard.enable' => 'Enable',
            'dashboard.current_temp' => 'Current',
            'dashboard.day_min' => 'Day min',
            'dashboard.day_max' => 'Day max',
            'seo.default_description' => 'Local weather station with live observations, charts, climate summaries and history.',
            'seo.dashboard_description' => 'Live station weather data: temperature, rain, wind, pressure and trends.',
            'seo.charts_description' => 'Interactive weather charts: temperature, humidity, pressure, wind and rainfall.',
            'seo.history_description' => 'Detailed history of station weather observations.',
            'seo.climate_description' => 'Monthly and yearly climate summary for the weather station.',
            'seo.terms_description' => 'Terms of use and legal information for this weather website.',
            'weather.unavailable' => 'Weather unavailable',
            'weather.trend.unavailable' => 'Trend unavailable',
            'rain.total' => 'Cumulative rainfall',
            'sea.title' => 'Sea temperature',
            'sea.subtitle' => 'Nearest marine point',
            'sea.distance' => 'Distance',
            'sea.updated' => 'Measure',
            'forecast.title' => 'Weather forecast',
            'forecast.today' => 'Today',
            'forecast.tomorrow' => 'Tomorrow',
            'forecast.precip' => 'Rain chance',
            'forecast.updated' => 'Forecast updated',
            'forecast.unavailable' => 'Forecast unavailable',
            'forecast.coords_required' => 'Set station latitude/longitude in admin settings.',
            'forecast.retry_later' => 'Retry in progress, refresh the page in a moment.',
            'metar.title' => 'METAR',
            'metar.nearest' => 'Nearest airport',
            'metar.raw' => 'Raw message',
            'metar.observed' => 'Observed',
            'metar.weather' => 'Weather',
            'metar.clouds' => 'Clouds',
            'metar.decoded' => 'Decoded',
            'metar.unavailable' => 'METAR unavailable',
            'forecast.condition.clear' => 'Sunny',
            'forecast.condition.partly_cloudy' => 'Partly cloudy',
            'forecast.condition.overcast' => 'Overcast',
            'forecast.condition.fog' => 'Fog',
            'forecast.condition.drizzle' => 'Drizzle',
            'forecast.condition.rain' => 'Rain',
            'forecast.condition.snow' => 'Snow',
            'forecast.condition.showers' => 'Showers',
            'forecast.condition.snow_showers' => 'Snow showers',
            'forecast.condition.thunderstorm' => 'Thunderstorm',
            'forecast.condition.unknown' => 'Variable weather',
            'station.card_title' => 'Station',
            'station.location' => 'Position',
            'station.altitude' => 'Altitude',
            'station.status' => 'Status',
            'station.last_update' => 'Last update',
            'extremes.card_title' => 'Extremes & ephemeris',
            'extremes.day_min' => 'Day low',
            'extremes.day_max' => 'Day high',
            'extremes.historical_avg' => 'Historical average',
            'extremes.day_min_time' => 'Low time',
            'extremes.day_max_time' => 'High time',
            'extremes.sunrise' => 'Sunrise',
            'extremes.sunset' => 'Sunset',
            'extremes.day_length' => 'Day length',
            'extremes.moment' => 'Time of day',
            'extremes.phase.before_sunrise' => 'Before sunrise',
            'extremes.phase.daylight' => 'Daylight',
            'extremes.phase.after_sunset' => 'After sunset',
            'extremes.event_ago' => '%s hour(s) ago',
            'extremes.event_in' => 'In %s hour(s)',
            'extremes.day_length_more' => '%d min longer than yesterday',
            'extremes.day_length_less' => '%d min shorter than yesterday',
            'extremes.day_length_same' => 'Same duration as yesterday',
            'rain.day_base' => 'Day',
            'rain.month_base' => 'Month',
            'rain.year_base' => 'Year',
            'rain.rolling_year_base' => 'Rolling 365 days',
            'rain.day' => 'Day (mm)',
            'rain.month' => 'Month (mm)',
            'rain.year' => 'Year (mm)',
            'rain.delta_day_vs_avg' => 'Δ vs average same day (other years)',
            'rain.delta_month_vs_avg' => 'Δ vs average same month (other years)',
            'rain.delta_year_vs_same_date_avg' => 'Δ vs average same date (other years)',
            'rain.delta_rolling_vs_avg' => 'Δ vs average rolling 365 days (other years)',
            'windrose.title' => 'Wind rose',
            'windrose.samples' => 'Today samples',
            'windrose.no_data' => 'Not enough wind data for today.',
            'windrose.period.1j' => '1d',
            'windrose.period.1s' => '1w',
            'windrose.period.1m' => '1m',
            'windrose.period.1a' => '1y',
            'windrose.dominant' => 'Dominant sector',
            'windrose.top' => 'Top sectors',
            'windrose.samples_for' => 'Samples (%s)',
            'btn.apply' => 'Apply',
            'btn.export_csv' => 'Export CSV',
            'history.title' => 'History',
            'charts.title' => 'Charts',
            'charts.density' => 'Density',
            'charts.density.auto' => 'Auto',
            'charts.density.compact' => 'Compact',
            'charts.density.dense' => 'Dense',
            'climate.title' => 'Climate',
            'climate.mode' => 'View',
            'climate.monthly' => 'Monthly',
            'climate.yearly' => 'Yearly',
            'climate.year' => 'Year',
            'climate.period' => 'Period',
            'climate.temp_range' => 'Temperature min/max',
            'climate.pressure_range' => 'Pressure min/max',
            'climate.rain_total' => 'Total rainfall',
            'climate.rain_1h_max' => 'Rain 1h max',
            'climate.wind_max' => 'Wind max',
            'climate.gust_max' => 'Gust max',
            'climate.dew_range' => 'Dew point min/max',
            'climate.apparent_range' => 'Apparent min/max',
            'period.24h' => '24h',
            'period.7d' => '7 days',
            'period.30d' => '30 days',
            'period.month' => 'Current month',
            'period.year' => 'Current year',
            'period.365d' => 'Rolling 365 days',
            'period.custom' => 'Custom period',
            'charts.from' => 'From',
            'charts.to' => 'To',
            'pagination.prev' => 'Prev',
            'pagination.next' => 'Next',
            'pagination.page' => 'Page',
            'common.na' => 'N/A',
            'common.yesterday' => 'Yesterday',
            'admin.title' => 'Admin',
            'admin.dashboard' => 'Dashboard',
            'admin.site' => 'Site',
            'admin.twofa' => '2FA',
            'admin.netatmo' => 'Netatmo',
            'admin.health' => 'Health',
            'admin.stats' => 'Stats',
            'admin.logs' => 'Logs',
            'admin.backups' => 'Backups',
            'admin.upgrade' => 'Upgrade',
            'admin.logout' => 'Logout',
            'admin.logout_confirm' => 'Confirm logout?',
            'backup.title' => 'SQL backups',
            'backup.subtitle' => 'Downloadable safety exports.',
            'backup.alldata_title' => 'alldata table export',
            'backup.alldata_desc' => 'Download an SQL dump of table alldata.',
            'backup.db_title' => 'Full database export',
            'backup.db_desc' => 'Download an SQL dump of all database tables.',
            'backup.download_alldata' => 'Download alldata.sql',
            'backup.download_db' => 'Download database.sql',
            'backup.table_missing' => 'Table alldata was not found in this database.',
            'backup.error' => 'SQL export failed',
            'logs.title' => 'Application logs',
            'logs.filter' => 'Filter',
            'logs.reset' => 'Reset',
            'logs.level' => 'Level',
            'logs.channel' => 'Channel',
            'logs.search' => 'Search',
            'logs.search_placeholder' => 'message/context',
            'logs.window' => 'Window',
            'logs.rows' => 'Rows',
            'logs.all' => 'All',
            'logs.found' => 'log(s) found',
            'logs.no_results' => 'No logs found.',
            'stats.title' => 'Audience statistics',
            'stats.window' => 'Window',
            'stats.sessions' => 'Sessions',
            'stats.unique_ips' => 'Unique IPs',
            'stats.pageviews' => 'Pageviews',
            'stats.avg_duration' => 'Average duration',
            'stats.total_duration' => 'Total time',
            'stats.top_pages' => 'Top pages',
            'stats.page' => 'Page',
            'stats.views' => 'Views',
            'stats.time_spent' => 'Time spent',
            'stats.top_geo' => 'Geo distribution',
            'stats.country' => 'Country',
            'stats.recent_sessions' => 'Recent sessions',
            'stats.start' => 'Start',
            'stats.last_seen' => 'Last seen',
            'stats.geo' => 'Geolocation',
            'stats.pages' => 'Pages',
            'stats.entry' => 'Entry',
            'stats.exit' => 'Exit',
            'site.title' => 'Site settings',
            'site.name' => 'Site name',
            'site.browser_title' => 'Browser title',
            'site.favicon_url' => 'Favicon URL/path',
            'site.weather_icon_style' => 'Weather icon style (Live)',
            'site.weather_icon_style_realistic' => 'Realistic',
            'site.weather_icon_style_minimal' => 'Minimal',
            'site.weather_icon_style_outline' => 'Outline',
            'site.weather_icon_style_glyph' => 'Glyph',
            'site.favicon_upload' => 'Upload favicon (ICO/PNG/JPG/WEBP, max 1 MB)',
            'site.favicon_current' => 'Current favicon',
            'site.contact' => 'Contact email',
            'site.table' => 'Data table',
            'site.default_locale' => 'Default locale',
            'site.station_zipcode' => 'Station zipcode (optional)',
            'site.station_lat' => 'Station latitude (optional)',
            'site.station_lon' => 'Station longitude (optional)',
            'site.station_altitude' => 'Station altitude (m, optional)',
            'site.forecast_sources' => 'Forecast sources',
            'site.forecast_source_openmeteo' => 'Open-Meteo',
            'site.forecast_source_metno' => 'MET Norway (met.no)',
            'site.forecast_sources_help' => 'You can select multiple sources. The first available source is used automatically.',
            'site.metar_default_icao' => 'Default METAR airport (ICAO code)',
            'site.metar_default_icao_help' => '4-letter ICAO code (e.g. LFML). Used when automatic airport lookup fails.',
            'site.station_lock_position' => 'Lock manual position (do not override from Netatmo)',
            'site.save' => 'Save',
            'site.saved' => 'Saved',
            'site.invalid' => 'Invalid values',
            'site.terms_content' => 'Terms of use content',
            'site.terms_content_help' => 'HTML allowed (p, br, strong, em, ul/ol/li, a, h2-h4, blockquote). Unsafe tags are filtered.',
            'terms.title' => 'Terms of use',
            'terms.empty' => 'No terms of use have been defined yet.',
            'metric.temperature' => 'Temperature (°C)',
            'metric.temperature_name' => 'Temperature',
            'metric.tmax_name' => 'Tmax',
            'metric.tmin_name' => 'Tmin',
            'metric.humidity' => 'Humidity (%)',
            'metric.humidity_name' => 'Humidity',
            'metric.pressure' => 'Pressure (hPa)',
            'metric.pressure_name' => 'Pressure',
            'metric.rain_1h' => 'Rain 1h (mm)',
            'metric.rain_1h_name' => 'Rain 1h',
            'metric.rain_day' => 'Rain day (mm)',
            'metric.rain_day_name' => 'Rain day',
            'metric.wind_avg' => 'Wind avg (km/h)',
            'metric.wind_avg_name' => 'Wind avg',
            'metric.wind_gust' => 'Wind gust (km/h)',
            'metric.wind_gust_name' => 'Wind gust',
            'metric.wind_dir' => 'Wind dir (°)',
            'metric.wind_dir_name' => 'Wind dir',
            'metric.dew_point' => 'Dew point (°C)',
            'metric.dew_point_name' => 'Dew point',
            'metric.apparent' => 'Apparent (°C)',
            'metric.apparent_name' => 'Apparent',
            'metrics.by_type' => 'Metrics by type',
            'metric.group.thermal' => 'Thermal and humidity',
            'metric.group.wind' => 'Wind',
            'metric.group.rain' => 'Rain',
            'metric.group.pressure' => 'Pressure',
            'metric.rain_episode_start' => 'Episode start',
            'metric.rain_episode_end' => 'Episode end',
            'metric.rain_episode_ongoing' => 'Ongoing',
            'metric.wind_dir_compass' => 'Wind direction (compass)',
            'metric.wind_dir_label' => 'Heading',
            'metric.wind_from_sector' => 'From sector',
            'metric.day_min_max' => 'Day min/max',
            'metric.pressure_trend' => 'Trend',
            'logs.message' => 'Message',
            'logs.context' => 'Context',
            'logs.date' => 'Date',
            'table.datetime' => 'DateTime',
            'table.temperature' => 'Temperature',
            'table.tmax' => 'Tmax',
            'table.tmin' => 'Tmin',
            'table.humidity' => 'Humidity',
            'table.dewpoint' => 'Dew point',
            'table.wind_avg' => 'Wind avg',
            'table.wind_gust' => 'Wind gust',
            'table.wind_dir' => 'Wind dir',
            'table.rain_1h' => 'Rain 1h',
            'table.rain_day' => 'Rain day',
            'table.pressure' => 'Pressure',
            'table.s' => 'S',
            'table.apparent' => 'Apparent',
            'upgrade.applied' => 'Migration applied',
            'upgrade.not_installed' => 'Application not installed',
            'login.title' => 'Admin login',
            'login.username' => 'Username',
            'login.password' => 'Password',
            'login.continue' => 'Continue',
            'login.failed' => 'Login failed',
            'login.logged_out' => 'You are now logged out.',
            'auth.invalid_credentials' => 'Invalid credentials',
            'auth.too_many_attempts' => 'Too many failed attempts. Retry in 10 minutes.',
            'auth.no_pending_login' => 'No pending login',
            'auth.invalid_2fa' => 'Invalid TOTP/backup code',
            'twofa.title' => 'Two-factor authentication',
            'twofa.manage_title' => '2FA management',
            'twofa.status' => 'Status',
            'twofa.status_enabled' => 'Enabled',
            'twofa.status_disabled' => 'Disabled',
            'twofa.enable' => 'Enable 2FA',
            'twofa.disable' => 'Disable 2FA',
            'twofa.regenerate' => 'Regenerate QR + backup codes',
            'twofa.enabled' => '2FA enabled',
            'twofa.disabled' => '2FA disabled',
            'twofa.scan_qr' => 'Configure your TOTP app with the secret or URI below',
            'twofa.secret' => 'Secret',
            'twofa.backup_codes' => 'Backup codes (store securely)',
            'twofa.confirm_disable' => 'Disable 2FA for this account?',
            'twofa.confirm_password' => 'Confirm with admin password',
            'twofa.disable_bad_password' => 'Invalid password',
            'twofa.warning_disabled' => '2FA is disabled for this admin account. Enable it to improve security.',
            'twofa.code' => 'TOTP or backup code',
            'twofa.remember_device' => 'Remember this device for 30 days',
            'twofa.remember_device_help' => 'Use this only on a trusted personal device.',
            'twofa.validate' => 'Validate',
            'twofa.invalid' => 'Invalid code',
            'twofa.backup_used' => 'Backup code used. Generate a new one if needed.',
            'admin.last_datetime' => 'Last DateTime',
            'admin.temperature' => 'Temperature',
            'admin.pressure' => 'Pressure',
            'netatmo.oauth' => 'Netatmo OAuth',
            'netatmo.client_id' => 'Client ID',
            'netatmo.client_secret' => 'Client Secret',
            'netatmo.save_credentials' => 'Save credentials',
            'netatmo.redirect_uri' => 'Redirect URI',
            'netatmo.token' => 'Token',
            'netatmo.configured' => 'Configured',
            'netatmo.missing' => 'Missing',
            'netatmo.expired' => 'expired',
            'netatmo.connect' => 'Connect / reconnect Netatmo',
            'netatmo.credentials_saved' => 'Credentials saved',
            'netatmo.credentials_required' => 'client_id and client_secret required',
            'netatmo.oauth_success' => 'OAuth connection successful',
            'health.title' => 'Health',
            'health.db_status' => 'DB status',
            'health.last_fetch' => 'Last cron fetch',
            'health.last_daily' => 'Last cron daily',
            'health.last_external' => 'Last cron external',
            'health.token_status' => 'Token status',
            'health.error_24h' => 'Error counter 24h',
            'health.position' => 'Active position used',
            'health.position_source' => 'Source',
            'health.position_lock' => 'Lock',
            'health.position_manual' => 'Manual',
            'health.position_auto' => 'Netatmo auto',
            'health.position_on' => 'Enabled',
            'health.position_off' => 'Disabled',
            'health.release_tag' => 'Release',
            'health.release_source' => 'Release source',
            'status.ok' => 'OK',
            'status.error' => 'ERROR',
            'upgrade.title' => 'Upgrade',
            'upgrade.target_version' => 'Target version',
            'upgrade.run' => 'Run upgrade',
            'upgrade.back_admin' => 'Back admin',
            'weather.label.offline' => 'Station offline',
            'weather.detail.offline' => 'No recent data from outdoor module',
            'weather.label.snow' => 'Snow',
            'weather.detail.snow' => 'Cold precipitation detected',
            'weather.label.rain' => 'Rain',
            'weather.detail.rain' => 'Precipitation in progress',
            'weather.label.wind' => 'Windy',
            'weather.detail.wind' => 'Strong gusts detected',
            'weather.label.very_cloudy' => 'Very cloudy',
            'weather.detail.very_cloudy' => 'High humidity',
            'weather.label.cloudy' => 'Cloudy',
            'weather.detail.cloudy' => 'Loaded sky',
            'weather.label.sunny' => 'Sunny',
            'weather.detail.sunny' => 'Dryer air',
            'weather.label.voile' => 'Partly cloudy',
            'weather.detail.voile' => 'Partly covered sky',
            'weather.trend.up' => 'Temperature trend: rising',
            'weather.trend.down' => 'Temperature trend: falling',
            'weather.trend.stable' => 'Temperature trend: stable',
            'weather.trend.unknown' => 'Temperature trend: unknown',
            'install.disabled' => 'Installer disabled (installed.lock exists).',
            'install.title' => 'Installer',
            'install.step' => 'Step',
            'install.complete' => 'Installation complete',
            'install.run_checks' => 'Run checks',
            'install.check_desc' => 'Check PHP, extensions and /config write access.',
            'install.connect' => 'Connect',
            'install.verify_table' => 'Verify table + PK',
            'install.create_tables' => 'Create tables',
            'install.create_tables_desc' => 'Create required app tables if missing.',
            'install.create_admin' => 'Create admin + 2FA seed',
            'install.save_netatmo' => 'Save Netatmo credentials',
            'install.generate_keys' => 'Generate keys',
            'install.finalize' => 'Finalize installation',
            'install.finalize_desc' => 'Finalize: create user/settings/secrets/config files + lock.',
        ],
    ];

    $locale = locale_current();
    return $dict[$locale][$key] ?? $dict['fr_FR'][$key] ?? $key;
}
